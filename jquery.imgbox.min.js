/*
 *  jquery-imgbox - v1.1.0
 *  A jQuery plugin that draws a box over an image.
 *  https://github.com/davidnewcomb/jquery-imgbox/
 *
 *  Copyright (c) 2018 David Newcomb, http://www.bigsoft.co.uk
 *  MIT License
 */
!function(Y){Y.fn.imgbox=function(n){var t={},e=function(){var e=(new Date).getTime();"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now());return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:3&t|8).toString(16)})}(),o={debug:!1,name:"",markStyle:{border:"1px solid yellow"},command:"",saveBox:function(n){console.log(n)},wrapIfInvalid:!1,retryInterval:1e3},l=Y.extend(o,n);"edit"==l.command&&(l.wrapIfInvalid=!0),l.markStyle.position="absolute";var x,a=this,i="imgbox-group-"+e,u=!1,c=0,s=0,h=0,d=0,r=r();function m(n){x=S(c,s,h,d),n.each(I)}function f(n){g(Y(this),n.offsetX,n.offsetY)}function y(n){var t=w(this);g(Y(this).parent().find("img"),t.x+n.offsetX,t.y+n.offsetY)}function v(n){M(this,n.offsetX,n.offsetY)}function p(n){var t=w(this);M(this,t.x+n.offsetX,t.y+n.offsetY)}function w(n){var t={};return t.x=parseInt(Y(n).css("left").replace(/px/,"")),t.y=parseInt(Y(n).css("top").replace(/px/,"")),t}function M(n,t,e){u&&(h=t,d=e,m(Y(n).parent()))}function g(n,t,e){var o,a,r,i,f;u?(x=S(c,s,h=t,d=e),o=Y(n),a=x,r=o.width(),i=o[0].naturalWidth/r,(f={}).x=Math.floor(a.x*i),f.y=Math.floor(a.y*i),f.x2=Math.floor(a.x2*i),f.y2=Math.floor(a.y2*i),f.w=Math.floor(a.w*i),f.h=Math.floor(a.h*i),o.data(f),l.saveBox(f)):(h=c=t,d=s=e,x=S(c,s,h,d)),m(Y(n).parent()),u=!u}function b(){Y("."+i).each(I)}function I(n,t){var e=k(n,t);if(!e){X("add timer");var o=setInterval(function(){X("run timer"),(e=k(n,t))&&clearInterval(o)},l.retryInterval)}}function k(n,t){var e,o=Y(t).find("img");if("edit"==l.command&&u)e=x=S(c,s,h,d);else{if(null==(e=function(n){if(null==n||null==n.x||null==n.y)return X("missing one of x,y"),null;if(null==n.w||null==n.h){if(null==n.x2||null==n.y2)return X("missing one of w,h|x2,y2"),null;n.w=Math.abs(n.x2-n.x),n.h=Math.abs(n.y2-n.y)}else null!=n.x2&&null!=n.y2||(n.x2=n.x+n.w,n.y2=n.y+n.h);return n}(o.data())))return!0;if(null==(e=function(n,t){var e=n.width(),o=n[0].naturalWidth;if(0==o)return X("realWidth:bad"),null;var a=e/o,r={};return r.x=Math.floor(t.x*a),r.y=Math.floor(t.y*a),r.x2=Math.floor(t.x2*a),r.y2=Math.floor(t.y2*a),r.w=Math.floor(t.w*a),r.h=Math.floor(t.h*a),r}(o,e)))return!1}var a={left:e.x,top:e.y,width:e.w,height:e.h},r=Y.extend({},l.markStyle,a);return Y(t).find("div").css(r),!0}function S(n,t,e,o){var a={};return a.x=Math.min(n,e),a.y=Math.min(t,o),a.x2=Math.max(n,e),a.y2=Math.min(t,o),a.w=Math.abs(n-e),a.h=Math.abs(t-o),a}function r(){var n="imgbox: ";return""==l.name?n+=i:n+=l.name+" ("+i+")",n}function X(n,t){l.debug&&(null==t?console.log("imgbox:"+r+" "+n):console.log("imgbox:"+r+" "+n,t))}return function(){if(0==(r=!1,a.each(function(n,t){var e=Y(t).parent(),o=Y("<div>");Y(o).on("click",y),Y(o).on("mousemove",p);var a=Y("<div>").attr({class:i}).css({position:"relative"}).append(Y(t)).append(o);Y(e).append(a),a.each(I),r=!0}),r))return X("page contains no elements");var r;Y(window).on("resize",b),"edit"==l.command&&(X("settings.command:edit"),Y(a).on("click",f),Y(a).on("mousemove",v))}(),Y("."+i).each(I),t.redraw=b,t}}(jQuery);
